#!/usr/bin/env bash

set -e

PLUGIN_INSTALL_DIR="${HOME}/.local/share/lawnch/plugins"
CONFIG_FILE="${HOME}/.config/lawnch/config.ini"

print_help() {
  echo "Usage: lawnchpm <command> [arguments]"
  echo ""
  echo "Commands:"
  echo "  build <plugin_dir>        - Build a plugin from a source directory."
  echo "  install <plugin_dir>      - Build and install a plugin."
  echo "  uninstall <plugin_name>   - Uninstall a plugin."
  echo "  list [--enabled|--disabled] - List installed plugins."
  echo "  enable <plugin_name>      - Enable a plugin in the config file."
  echo "  disable <plugin_name>     - Disable a plugin in the config file."
  echo "  help                      - Show this help message."
}

cmd_build() {
  plugin_dir="$1"
  if [ ! -d "$plugin_dir" ]; then
    echo "Error: Directory '$plugin_dir' not found."
    exit 1
  fi

  build_dir="${plugin_dir}/build"
  mkdir -p "$build_dir"

  echo "--- Configuring plugin in $plugin_dir ---"
  cmake -S "$plugin_dir" -B "$build_dir"
  echo "--- Building plugin ---"
  cmake --build "$build_dir"
}

cmd_install() {
  plugin_dir="$1"
  cmd_build "$plugin_dir"

  plugin_name=$(basename "$plugin_dir")
  so_file="${plugin_dir}/build/${plugin_name}.so"

  if [ ! -f "$so_file" ]; then
    echo "Error: Built plugin file not found at '$so_file'"
    exit 1
  fi
  
  echo "--- Installing plugin $plugin_name ---"
  mkdir -p "$PLUGIN_INSTALL_DIR"
  cp "$so_file" "$PLUGIN_INSTALL_DIR/"
  echo "Plugin '$plugin_name' installed successfully."
  echo "WARNING: Installing third-party plugins can be a security risk."
  echo "Only install plugins from sources you trust."
}

cmd_uninstall() {
  plugin_name="$1"
  so_file="${PLUGIN_INSTALL_DIR}/${plugin_name}.so"

  if [ ! -f "$so_file" ]; then
    echo "Error: Plugin '$plugin_name' is not installed."
    exit 1
  fi

  rm "$so_file"
  echo "Plugin '$plugin_name' uninstalled."
}

cmd_list() {
  if [ ! -d "$PLUGIN_INSTALL_DIR" ] || [ -z "$(ls -A $PLUGIN_INSTALL_DIR)" ]; then
    echo "No plugins installed."
    return
  fi

  installed_plugins=()
  while IFS= read -r line; do
    installed_plugins+=("$line")
  done < <(find "$PLUGIN_INSTALL_DIR" -name '*.so' -exec basename {} .so \;)

  if [ "$1" == "--enabled" ]; then
    echo "Enabled plugins:"
    for plugin in "${installed_plugins[@]}"; do
      if grep -q "^${plugin}=true" "$CONFIG_FILE"; then
        echo "  - $plugin"
      fi
    done
  elif [ "$1" == "--disabled" ]; then
    echo "Disabled plugins:"
    for plugin in "${installed_plugins[@]}"; do
      if ! grep -q "^${plugin}=true" "$CONFIG_FILE"; then
        echo "  - $plugin"
      fi
    done
  else
    echo "Installed plugins:"
    for plugin in "${installed_plugins[@]}"; do
      echo "  - $plugin"
    done
  fi
}

cmd_enable() {
    plugin_name="$1"
    so_file="${PLUGIN_INSTALL_DIR}/${plugin_name}.so"

    if [ ! -f "$so_file" ]; then
        echo "Error: Plugin '$plugin_name' is not installed."
        exit 1
    fi

    if ! grep -q "\[plugins\]" "$CONFIG_FILE"; then
        echo -e "\n\[plugins\]" >> "$CONFIG_FILE"
    fi

    if grep -q "^${plugin_name}=" "$CONFIG_FILE"; then
        sed -i "/^${plugin_name}=/c\\${plugin_name}=true" "$CONFIG_FILE"
    else
        sed -i "/\[plugins\]/a\\${plugin_name}=true" "$CONFIG_FILE"
    fi
    echo "Plugin '$plugin_name' enabled."
}

cmd_disable() {
    plugin_name="$1"
    sed -i "/^${plugin_name}=/c\\${plugin_name}=false" "$CONFIG_FILE"
    echo "Plugin '$plugin_name' disabled."
}


COMMAND="$1"
shift || true

case "$COMMAND" in
  build)
    if [ -z "$1" ]; then echo "Error: Missing <plugin_dir> for build command."; print_help; exit 1; fi
    cmd_build "$1"
    ;; 
  install)
    if [ -z "$1" ]; then echo "Error: Missing <plugin_dir> for install command."; print_help; exit 1; fi
    cmd_install "$1"
    ;; 
  uninstall)
    if [ -z "$1" ]; then echo "Error: Missing <plugin_name> for uninstall command."; print_help; exit 1; fi
    cmd_uninstall "$1"
    ;; 
  list)
    cmd_list "$1"
    ;; 
  enable)
    if [ -z "$1" ]; then echo "Error: Missing <plugin_name> for enable command."; print_help; exit 1; fi
    cmd_enable "$1"
    ;; 
  disable)
    if [ -z "$1" ]; then echo "Error: Missing <plugin_name> for disable command."; print_help; exit 1; fi
    cmd_disable "$1"
    ;; 
  help|--help|-h)
    print_help
    ;; 
  *)
    if [ -n "$COMMAND" ]; then echo "Error: Unknown command '$COMMAND'"
fi
    print_help
    exit 1
    ;; 
esac